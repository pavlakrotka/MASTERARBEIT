---
title: "MT: Generalized additive models for non-concurrent comparisons in platform trials - preliminary simulations"
author: "Pavla Krotka, Marta Bofill Roig"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: true
    number_sections: true
    code_folding: show 
    theme: flatly
---

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(collapse = TRUE,
               echo = FALSE,
               comment = "#>",
               warning = FALSE,
               message = FALSE,
               fig.align = "center",
               out.width = "100%")
```

```{r, warning=FALSE, message=FALSE, include=FALSE}
library(tidyverse)
library(kableExtra)
library(latex2exp)
library(NCC)
library(mgcv)
library(splines)
set.seed(717)
```

```{r}
results_iii_gam_eq_alpha <- read_csv("results/results_iii_gam_eq_alpha.csv")
results_iii_gam_eq_pow <- read_csv("results/results_iii_gam_eq_pow.csv")

results_iii_splines_eq_alpha <- read_csv("results/results_iii_splines_eq_alpha.csv")
results_iii_splines_eq_pow <- read_csv("results/results_iii_splines_eq_pow.csv")
```

# Introduction

The following preliminary simulation study aims to explore different approaches to perform treatment-control comparisons using non-concurrent controls (NCC), where the time trend is modeled using splines. In the considered scenarios, continuous endpoints are assumed.

# Considered scenario

- 4 experimental treatment arms
- $n=250$
- equal time trend - $\lambda \in [-0.5; 0.5]$
- entry times $d_i = 250 \cdot (i-1)$
- $\theta_k=0.25$ under $H_1$
- linear and stepwise (jump only when new arm enters) time trends

## Overview

```{r}
d <- 250
trial_data <- datasim_cont(num_arms = 4, n_arm = 250, d = d*c(0:3), theta = rep(0, 4), lambda = rep(0.5, 5), sigma = 1, trend = "stepwise_2", full = T)$Data

plot_trial(trial_data$treatment) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d = ", d))

ggplot(trial_data) +
  geom_point(aes(x=j, y=means, color=as.factor(treatment)), size=2) +
  labs(x = "Patients in the trial", y = "Mean response under H0", color="Treatment", title = "Mean response")

ggplot(trial_data) +
  geom_point(aes(x=j, y=response, color=as.factor(treatment)), size=2, alpha=0.7) +
  labs(x = "Patients in the trial", y = "Response", color="Treatment", title = "Simulated response")
```

# Considered splines

In order to capture potential non-linearity of the time trend, we consider estimating the patient response using spline regression. The model is given by:

$$y_{j} = \eta_0  + \sum_{k \in \mathcal{K}_M} \theta_k \cdot I(k_j=k) + f(j) + \varepsilon_{j}$$
$\eta_0$ is the response in the control arm; $\theta_k$ represents the effect of treatment $k$ compared to control and the residuals are $\varepsilon_j \sim \mathcal{N}(0, \sigma^2)$.

The time trend is modeled via a continuous function $f(j)$ of the patient index $j$, which also indicates their entry time. This gives the model additional flexibility as compared to modeling the time trend with a categorical covariate.

## B-splines

In particular, we consider the B-spline function to model the time trend. This function is composed of multiple polynomial functions of a given degree $d$, which are joined together at points called \textit{knots}, such that the whole spline is continuous up to $d-1$ derivative. In our case, the knots are placed within the range of the patient index $j$. To define a B-spline function, we first define the knot sequence 

$$\zeta_1 = \ldots = \zeta_d = \zeta_{d+1} < \zeta_{d+2} < \ldots < \zeta_{d+Z+1} < \zeta_{d+Z+2} = \zeta_{d+Z+3} = \ldots = \zeta_{2d+Z+2}$$

- $Z$ knots in the set $\{ \zeta_{d+2}, \ldots, \zeta_{d+Z+1} \}$ = \textit{inner knots}
- $\zeta_{d+1}$ and $\zeta_{d+Z+2}$ = \textit{boundary knots}
- $\{ \zeta_1, \ldots, \zeta_{d} \}$ and $\{ \zeta_{d+Z+3}, \ldots, \zeta_{Z+2d+2} \}$ = additional knots needed because of the recursive definition of the B-spline

The function $f(j)$ can then be represented by a set of basis functions $B_i^d(j)$ as follows:

$$f(j) = \sum_{i=1}^{d+Z+1} B_i^d (j) \beta_i$$

where $\beta_i$ are the associated regression coefficients and the functions $B_i^d(j)$ are defined using the Cox-de Boor recursion formula as follows:


$$B_i^d(j) = \frac{j - \zeta_i}{\zeta_{i+d} - \zeta_i} B_i^{d-1}(j) + \frac{\zeta_{i+d+1} - j}{\zeta_{i+d+1} - \zeta_{i+1}} B_{i+1}^{d-1}(j), \hspace{0.7cm} i = 1, \ldots, d+Z+1$$

with

$$B_i^{0} =
    \begin{cases} 
      1 & \zeta_i \le j < \zeta_{i+1} \\
      0 & \mathrm{otherwise}
   \end{cases}$$

and

$$B_i^{0} \equiv 0 \hspace{0.2cm} \mathrm{if} \hspace{0.2cm} \zeta_i = \zeta_{i+1}$$

### Position of knots

- Place the inner knots to the beginning of each period $s=2,\ldots,S$, such that one polynomial of degree $d$ is always fitted to each period. In this case, the number of inner knots $Z=S-1$. 

- Place the inner knots equidistantly, according to the length of the calendar time unit, and thus fitting a polynomial of degree $d$ to each calendar time interval, which leads to $Z=C-1$.

- Boundary knots are always set to 1 and $N$, hence to the beginning and end of the trial.

### Degree of polynomial

Regarding the degree of the fitted polynomial, we explore linear, quadratic and cubic splines, i.e. $d \in (1,2,3)$.

### Results

For comparative purposes, the results using a regression model with fixed effects and period or calendar time adjustment are plotted as well. In a setting with linear time trend, both newly considered approaches (B-splines with both strategies for placing knots) maintain the type I error at 2.5\%, regardless of the strength of the time trend. However, if the time trend is stepwise, the only the B-spline where knots are placed according to the calendar time maintains the T1E. If the polynomial is only fitted for each periods, the T1E is inflated in the presence of stepwise time trends. The degree of the polynomial does not seem to play major role for the T1E and power. The power using B-splines with knots according to calendar time is comparable to the power obtained using the fixed effect regression model.

#### Linear spline

```{r}
knots <- c(250, 500, 667, 750, 1139, 1391)
mod_lin <- lm(response ~ as.factor(treatment) + bs(j, knots = knots, degree = 1), data = trial_data)

ggplot(trial_data) + 
  aes(x = j, y = response, color = as.factor(treatment)) + 
  geom_point(alpha = 0.5) + 
  geom_line(aes(y = fitted(mod_lin)), size=1) +
  labs(x = "Patient recruitment", y = "Response", color = "Treatment:")
```

##### Type I error

```{r}
ggplot(results_iii_splines_eq_alpha %>% filter(bs_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:", linetype = "Arm under study:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  scale_color_discrete(labels = c("Fixmodel - periods", "Fixmodel - calendar time", "Splines - periods", "Splines - calendar time"))
```

##### Power

```{r}
ggplot(results_iii_splines_eq_pow %>% filter(bs_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:", linetype = "Arm under study:") +
  facet_grid(~ trend) +
  scale_color_discrete(labels = c("Fixmodel - periods", "Fixmodel - calendar time", "Splines - periods", "Splines - calendar time"))
```


#### Quadratic spline

```{r}
knots <- c(250, 500, 667, 750, 1139, 1391)
mod_quad <- lm(response ~ as.factor(treatment) + bs(j, knots = knots, degree = 2), data = trial_data)

ggplot(trial_data) + 
  aes(x = j, y = response, color = as.factor(treatment)) + 
  geom_point(alpha = 0.5) + 
  geom_line(aes(y = fitted(mod_quad)), size=1) +
  labs(x = "Patient recruitment", y = "Response", color = "Treatment:")
```

##### Type I error

```{r}
ggplot(results_iii_splines_eq_alpha %>% filter(bs_degree==2)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:", linetype = "Arm under study:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  scale_color_discrete(labels = c("Fixmodel - periods", "Fixmodel - calendar time", "Splines - periods", "Splines - calendar time"))
```

##### Power

```{r}
ggplot(results_iii_splines_eq_pow %>% filter(bs_degree==2)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:", linetype = "Arm under study:") +
  facet_grid(~ trend) +
  scale_color_discrete(labels = c("Fixmodel - periods", "Fixmodel - calendar time", "Splines - periods", "Splines - calendar time"))
```

#### Cubic spline

```{r}
knots <- c(250, 500, 667, 750, 1139, 1391)
mod_cub <- lm(response ~ as.factor(treatment) + bs(j, knots = knots, degree = 3), data = trial_data)

ggplot(trial_data) + 
  aes(x = j, y = response, color = as.factor(treatment)) + 
  geom_point(alpha = 0.5) + 
  geom_line(aes(y = fitted(mod_cub)), size=1) +
  labs(x = "Patient recruitment", y = "Response", color = "Treatment:")
```

##### Type I error

```{r}
ggplot(results_iii_splines_eq_alpha %>% filter(bs_degree==3)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:", linetype = "Arm under study:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  scale_color_discrete(labels = c("Fixmodel - periods", "Fixmodel - calendar time", "Splines - periods", "Splines - calendar time"))
```

##### Power

```{r}
ggplot(results_iii_splines_eq_pow %>% filter(bs_degree==3)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:", linetype = "Arm under study:") +
  facet_grid(~ trend) +
  scale_color_discrete(labels = c("Fixmodel - periods", "Fixmodel - calendar time", "Splines - periods", "Splines - calendar time"))
```


# Next Steps

- **Simulation settings:**
    - Discuss further designs to be considered
    - Model other time trend patterns (inverted u, linear starting later during the trial, seasonal time trend)


- **Explore different strategies of fitting polynomials:**
    - Smooth over $t_j$ instead of $j$ with larger intervals
    - Piecewise regression without the constraint of continuity in the knots
    - Make more profit of the flexibility of generalized additive models (GAMs)


- **TBD: Assumptions for T1E control when using splines:**
    - As in the stepwise models, we rely on equal time trends
    - By using splines, can we relax the assumption regarding the additive effect of the time trends on the model?
    - Time trend is a continuous function






```{r}
knit_exit()
```


## GAMs with different smoothing bases


### cr - Cubic regression splines

```{r}
gam <- gam(response ~ as.factor(treatment) + s(j, bs = "cr"), data = trial_data)

ggplot(trial_data) + 
  aes(x = j, y = response, color = as.factor(treatment)) + 
  geom_point(alpha = 0.5) + 
  geom_line(aes(y = fitted(gam)), size=1) +
  labs(x = "Patient recruitment", y = "Response", color = "Treatment:")
```


### gp - Gaussian process smooths

```{r}
gam <- gam(response ~ as.factor(treatment) + s(j, bs = "gp"), data = trial_data)

ggplot(trial_data) + 
  aes(x = j, y = response, color = as.factor(treatment)) + 
  geom_point(alpha = 0.5) + 
  geom_line(aes(y = fitted(gam)), size=1) +
  labs(x = "Patient recruitment", y = "Response", color = "Treatment:")
```

### ps - P-splines

```{r}
gam <- gam(response ~ as.factor(treatment) + s(j, bs = "ps"), data = trial_data)

ggplot(trial_data) + 
  aes(x = j, y = response, color = as.factor(treatment)) + 
  geom_point(alpha = 0.5) + 
  geom_line(aes(y = fitted(gam)), size=1) +
  labs(x = "Patient recruitment", y = "Response", color = "Treatment:")
```

### re - Random effects

```{r}
gam <- gam(response ~ as.factor(treatment) + s(j, bs = "re"), data = trial_data)

ggplot(trial_data) + 
  aes(x = j, y = response, color = as.factor(treatment)) + 
  geom_point(alpha = 0.5) + 
  geom_line(aes(y = fitted(gam)), size=1) +
  labs(x = "Patient recruitment", y = "Response", color = "Treatment:")
```

### tp - Thin plate regression splines

```{r}
gam <- gam(response ~ as.factor(treatment) + s(j, bs = "tp"), data = trial_data)

ggplot(trial_data) + 
  aes(x = j, y = response, color = as.factor(treatment)) + 
  geom_point(alpha = 0.5) + 
  geom_line(aes(y = fitted(gam)), size=1) +
  labs(x = "Patient recruitment", y = "Response", color = "Treatment:")
```


### Results

#### Type I error

```{r}
ggplot(results_iii_gam_eq_alpha) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(smoothing_basis), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(smoothing_basis))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Smoothing basis:", linetype = "Arm under study:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend)
```

#### Power

```{r}
ggplot(results_iii_gam_eq_pow) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(smoothing_basis), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(smoothing_basis))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Smoothing basis:", linetype = "Arm under study:") +
  facet_grid(~ trend)
```
















