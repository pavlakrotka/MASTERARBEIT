---
title: "MT: Model-based Adjustments for Non-concurrent Comparisons in Platform Trials - preliminary simulations"
author: "Pavla Krotka, Marta Bofill Roig"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: true
    number_sections: true
    code_folding: show 
    theme: flatly
---

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(collapse = TRUE,
               echo = FALSE,
               comment = "#>",
               warning = FALSE,
               message = FALSE,
               fig.align = "center",
               out.width = "100%")
```

```{r, warning=FALSE, message=FALSE, include=FALSE}
library(tidyverse)
library(kableExtra)
library(latex2exp)
library(NCC)
library(mgcv)
library(splines)
set.seed(717)
```

```{r}
results_iii_eq_alpha <- read_csv("results/results_iii_eq_alpha.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))
results_iii_eq_pow <- read_csv("results/results_iii_eq_pow.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))

results_iv_eq_alpha <- read_csv("results/results_iv_eq_alpha.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))
results_iv_eq_pow <- read_csv("results/results_iv_eq_pow.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))

results_v_eq_alpha <- read_csv("results/results_v_eq_alpha.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))
results_v_eq_pow <- read_csv("results/results_v_eq_pow.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))
```

# Introduction

The following preliminary simulation study aims to explore different approaches to perform treatment-control comparisons using non-concurrent controls (NCC), where the time trend is modeled using splines. In the considered scenarios, continuous endpoints are assumed.

# Scenario with 4 arms

- 4 experimental treatment arms
- $n=250$
- equal time trend - $\lambda \in [-0.5; 0.5]$
- entry times $d_i = 250 \cdot (i-1)$
- $\theta_k=0.25$ under $H_1$
- linear, stepwise (jump only when new arm enters), inverted_u ($N_{peak}=750$) and seasonal ($\psi=1,2$) time trends

## Overview

```{r}
d <- 250
trial_data <- datasim_cont(num_arms = 4, n_arm = 250, d = d*c(0:3), theta = rep(0, 4), lambda = rep(0.5, 5), sigma = 1, trend = "stepwise_2", full = T)$Data

plot_trial(trial_data$treatment) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d = ", d))

ggplot(trial_data) +
  geom_point(aes(x=j, y=means, color=as.factor(treatment)), size=2) +
  labs(x = "Patients in the trial", y = "Mean response under H0", color="Treatment", title = "Mean response")

ggplot(trial_data) +
  geom_point(aes(x=j, y=response, color=as.factor(treatment)), size=2, alpha=0.7) +
  labs(x = "Patients in the trial", y = "Response", color="Treatment", title = "Simulated response")
```


## Results

### Period vs. calendar time adjustment

#### Fixed effects models

```{r}
ggplot(results_iii_eq_alpha %>% filter(model %in% c("fixmodel", "fixmodel_cal", "sepmodel"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==3, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```

```{r}
ggplot(results_iii_eq_pow %>% filter(model %in% c("fixmodel", "fixmodel_cal", "sepmodel"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==3, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```



#### Mixed effects models

```{r}
ggplot(results_iii_eq_alpha %>% filter(model %in% c("mixmodel", "mixmodel_cal", "sepmodel"), trend %in%c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==3, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```

```{r}
ggplot(results_iii_eq_pow %>% filter(model %in% c("mixmodel", "mixmodel_cal", "sepmodel"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==3, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


#### Mixed effects models with AR1

```{r}
ggplot(results_iii_eq_alpha %>% filter(model %in% c("mixmodel_AR1", "mixmodel_AR1_cal", "sepmodel"), trend %in%c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==3, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```

```{r}
ggplot(results_iii_eq_pow %>% filter(model %in% c("mixmodel_AR1", "mixmodel_AR1_cal", "sepmodel"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==3, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


### Different lengths of calendar time interval


```{r}
ggplot(results_v_eq_alpha %>% filter(model %in% c("fixmodel_cal", "mixmodel_cal", "mixmodel_AR1_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==3, poly_degree==1)) +
  geom_line(aes(unit_size, reject_h0, color = as.factor(model))) +
  geom_point(aes(unit_size, reject_h0, color = as.factor(model))) +
  labs(x="Unit size", y="Type I error", color="Model:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


```{r}
ggplot(results_v_eq_pow %>% filter(model %in% c("fixmodel_cal", "mixmodel_cal", "mixmodel_AR1_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==3, poly_degree==1)) +
  geom_line(aes(unit_size, reject_h0, color = as.factor(model))) +
  geom_point(aes(unit_size, reject_h0, color = as.factor(model))) +
  labs(x="Unit size", y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


# Scenario with 7 arms

- 7 experimental treatment arms
- $n=250$
- equal time trend - $\lambda \in [-0.5; 0.5]$
- entry times $d = 250 \cdot (0,1,1,2,2,3,3)$
- $\theta_k=0.25$ under $H_1$
- linear, stepwise (jump only when new arm enters), inverted_u ($N_{peak}=914$) and seasonal ($\psi=1,2$) time trends

## Overview

```{r}
d <- 250
trial_data <- datasim_cont(num_arms = 7, n_arm = 250, d = d*c(0,1,1,2,2,3,3), theta = rep(0, 7), lambda = rep(0.5, 8), sigma = 1, trend = "stepwise_2", full = T)$Data

plot_trial(trial_data$treatment) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d = ", d))

ggplot(trial_data) +
  geom_point(aes(x=j, y=means, color=as.factor(treatment)), size=2) +
  labs(x = "Patients in the trial", y = "Mean response under H0", color="Treatment", title = "Mean response")

ggplot(trial_data) +
  geom_point(aes(x=j, y=response, color=as.factor(treatment)), size=2, alpha=0.7) +
  labs(x = "Patients in the trial", y = "Response", color="Treatment", title = "Simulated response")
```



## Results

### Linear polynomials

```{r}
ggplot(results_iv_eq_alpha %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==5, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


```{r}
ggplot(results_iv_eq_pow %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


### Quadratic polynomials

```{r}
ggplot(results_iv_eq_alpha %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==2)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:", linetype = "Arm under study:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


```{r}
ggplot(results_iv_eq_pow %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==2)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```



### Cubic polynomials

```{r}
ggplot(results_iv_eq_alpha %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==3)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


```{r}
ggplot(results_iv_eq_pow %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==3)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```




