---
title: "Master thesis: Model-based Adjustments for Non-concurrent Comparisons in Platform Trials"
author: "Pavla Krotka"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: true
    number_sections: true
    code_folding: show 
    theme: flatly
---

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(collapse = TRUE,
               echo = FALSE,
               comment = "#>",
               warning = FALSE,
               message = FALSE,
               fig.align = "center",
               out.width = "100%")
```

```{r, warning=FALSE, message=FALSE, include=FALSE}
library(tidyverse)
library(kableExtra)
library(latex2exp)
library(ggpubr)
library(scales)
library(NCC)
set.seed(717)
```

```{r}
# Load results 

results_setting_1_alpha <- read_csv("results/results_setting_1_alpha.csv")
results_setting_1_pow <- read_csv("results/results_setting_1_pow.csv")

results_setting_2_alpha <- read_csv("results/results_setting_2_alpha.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))
results_setting_2_pow <- read_csv("results/results_setting_2_pow.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))

results_setting_3_alpha <- read_csv("results/results_setting_3_alpha.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))
results_setting_3_pow <- read_csv("results/results_setting_3_pow.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))

results_setting_4_alpha <- read_csv("results/results_setting_4_alpha.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))
results_setting_4_pow <- read_csv("results/results_setting_4_pow.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))
```

```{r}
# Names for trend patterns
trend_names <- c(linear = "Linear trend", stepwise_2 = "Stepwise trend", inv_u = "Inverted-U trend", seasonal_1 = "Seasonal trend with 1 cycle", seasonal_2 = "Seasonal trend with 2 cycles")

# Names for splines degrees
degree_names <- c(`1` = "Linear splines", `2` = "Quadratic splines", `3` = "Cubic splines")

# Color palette
my_palette = c("#E41A1C",
               "#377EB8",
               "#4DAF4A",
               "#EEAD0E",
               "#925E9FFF",
               "#1B1919FF",
               "#FDAF91FF",
               "#00468BFF",
               "#42B540FF",
               "#0099B4FF")

#show_col(my_palette)

# Prediction interval for T1E
alpha <- 0.025
nsim <- 10000
sd <- sqrt(alpha*(1-alpha)/nsim)
z.alpha <- qnorm(1-alpha,0,1)
pred_int <- c(alpha-z.alpha*sd,alpha+z.alpha*sd)
#pred_int
```


# Introduction

This file contains all figures presented in Chapter 3 and Appendix A.1 in the master thesis *"Model-based Adjustments for Non-concurrent Comparisons in Platform Trials"*. 


# Investigated models

**Fixed effect models:**

- with period adjustment
- with calendar time adjustment

**Mixed effect models:**

- with period adjustment
- with calendar time adjustment
- with period adjustment and AR1 covariance structure
- with calendar time adjustment and AR1 covariance structure

**Spline regression:**

- polynomial splines with knots placed according to periods
- polynomial splines with knots placed according to calendar times


# SETTING 1 - 10 treatment arms

## Main text

```{r, fig.width=6, fig.height=4}
d <- 400

trial_data <- datasim_cont(num_arms = 10, n_arm = 250, d = d*c(0:9), theta = rep(0, 10), lambda = rep(0.5, 11), sigma = 1, trend = "stepwise_2", full = T)$Data


plot_trial(trial_data$treatment) +
  scale_color_manual(values = c(rep("gray48", 5), "darkred", rep("gray48", 5)))

ggsave("figures/trial_10arms.png", width = 6, height = 4)
```



```{r, fig.width=10, fig.height=5}
ggarrange(ggplot(results_setting_1_alpha %>% filter(study_arm==5 & d2==400)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda0, reject_h0, color=model)) +
            geom_point(aes(lambda0, reject_h0, color=model)) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            #coord_cartesian(ylim = c(0, 0.3)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            theme_bw(),
          
          ggplot(results_setting_1_pow %>% filter(study_arm==5 & d2==400)) +
            geom_line(aes(lambda0, reject_h0, color=model)) +
            geom_point(aes(lambda0, reject_h0, color=model)) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            coord_cartesian(ylim = c(0.70, 1)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            theme_bw(),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_alpha_pow_lambda.png", width = 10, height = 5)
```


```{r, fig.width=10, fig.height=5}
ggarrange(ggplot(results_setting_1_alpha %>% filter(study_arm==5 & lambda0==0.5)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(d2, reject_h0, color=model)) +
            geom_point(aes(d2, reject_h0, color=model)) +
            labs(x=TeX("$d$"), y="Type I error", color="Analysis approach:") +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            #coord_cartesian(ylim = c(0, 0.3)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_setting_1_pow %>% filter(study_arm==5 & lambda0==0.5)) +
            geom_line(aes(d2, reject_h0, color=model)) +
            geom_point(aes(d2, reject_h0, color=model)) +
            labs(x=TeX("$d$"), y="Power", color="Analysis approach:") +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            coord_cartesian(ylim = c(0.70, 1)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_alpha_pow_d.png", width = 10, height = 5)
```




```{r, fig.width=10, fig.height=5}
ggarrange(ggplot(results_setting_1_alpha %>% filter(d2==200 & lambda0==0.5)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(study_arm, reject_h0, color=model)) +
            geom_point(aes(study_arm, reject_h0, color=model)) +
            labs(x="Study arm", y="Type I error", color="Analysis approach:") +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            #coord_cartesian(ylim = c(0, 0.3)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            scale_x_continuous(breaks = c(1:10), labels = c(1:10)) +
            theme_bw(),
          
          ggplot(results_setting_1_pow %>% filter(d2==200 & lambda0==0.5)) +
            geom_line(aes(study_arm, reject_h0, color=model)) +
            geom_point(aes(study_arm, reject_h0, color=model)) +
            labs(x="Study arm", y="Power", color="Analysis approach:") +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            coord_cartesian(ylim = c(0.70, 1)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            scale_x_continuous(breaks = c(1:10), labels = c(1:10)) +
            theme_bw(),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_alpha_pow_study_arm.png", width = 10, height = 5)
```


## Appendix

- Rows - investigated arm

```{r, fig.width=10, fig.height=15}
ggarrange(ggplot(results_setting_1_alpha %>% filter(d2==400)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda0, reject_h0, color=model)) +
            geom_point(aes(lambda0, reject_h0, color=model)) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            #coord_cartesian(ylim = c(0, 0.3)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            theme_bw(),
          
          ggplot(results_setting_1_pow %>% filter(d2==400)) +
            geom_line(aes(lambda0, reject_h0, color=model)) +
            geom_point(aes(lambda0, reject_h0, color=model)) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            coord_cartesian(ylim = c(0.70, 1)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            theme_bw(),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_alpha_pow_lambda_all_arms.png", width = 10, height = 15)
```


- Rows - investigated arm

```{r, fig.width=10, fig.height=15}
ggarrange(ggplot(results_setting_1_alpha %>% filter(lambda0==0.5)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(d2, reject_h0, color=model)) +
            geom_point(aes(d2, reject_h0, color=model)) +
            labs(x=TeX("$d$"), y="Type I error", color="Analysis approach:") +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            # coord_cartesian(ylim = c(0, 0.3)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_setting_1_pow %>% filter(lambda0==0.5)) +
            geom_line(aes(d2, reject_h0, color=model)) +
            geom_point(aes(d2, reject_h0, color=model)) +
            labs(x=TeX("$d$"), y="Power", color="Analysis approach:") +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            coord_cartesian(ylim = c(0.70, 1)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_alpha_pow_d_all_arms.png", width = 10, height = 15)
```


- Rows - $d$

```{r, fig.width=10, fig.height=15}
ggarrange(ggplot(results_setting_1_alpha %>% filter(d2 %in% c(0, 100, 200, 300, 400, 500) & lambda0==0.5)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(study_arm, reject_h0, color=model)) +
            geom_point(aes(study_arm, reject_h0, color=model)) +
            labs(x="Study arm", y="Type I error", color="Analysis approach:") +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            facet_grid(d2 ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            #coord_cartesian(ylim = c(0, 0.3)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            scale_x_continuous(breaks = c(1:10), labels = c(1:10)) +
            theme_bw(),
          
          ggplot(results_setting_1_pow %>% filter(d2 %in% c(0, 100, 200, 300, 400, 500) & lambda0==0.5)) +
            geom_line(aes(study_arm, reject_h0, color=model)) +
            geom_point(aes(study_arm, reject_h0, color=model)) +
            labs(x="Study arm", y="Power", color="Analysis approach:") +
            facet_grid(d2 ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            coord_cartesian(ylim = c(0.70, 1)) +
            scale_color_manual(labels = c("Regression model", "Pooled analysis", "Separate analysis"), values = my_palette) +
            scale_x_continuous(breaks = c(1:10), labels = c(1:10)) +
            theme_bw(),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_alpha_pow_study_arm_all_d.png", width = 10, height = 15)
```

# SETTING 2 - 4 treatment arms

## Main text

```{r, fig.width=6, fig.height=4}
d <- 250
trial_data <- datasim_cont(num_arms = 4, n_arm = 250, d = d*c(0:3), theta = rep(0, 4), lambda = rep(0.5, 5), sigma = 1, trend = "stepwise_2", full = T)$Data

plot_trial(trial_data$treatment) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c(rep("gray48", 3), "darkred", rep("gray48", 1)))

ggsave("figures/trial_4arms.png", width = 6, height = 4)
```



```{r, fig.width=10, fig.height=6}
ggarrange(ggplot(results_setting_2_alpha %>% filter(study_arm==3, lambda1==0.125)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(unit_size, reject_h0, color = as.factor(model))) +
            geom_point(aes(unit_size, reject_h0, color = as.factor(model)), size = 1) +
            labs(x="Calendar unit size", y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_setting_2_pow %>% filter(study_arm==3, lambda1==0.125)) +
            geom_line(aes(unit_size, reject_h0, color = as.factor(model))) +
            geom_point(aes(unit_size, reject_h0, color = as.factor(model)), size = 1) +
            labs(x="Calendar unit size", y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom",
          nrow = 2) + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_cal_alpha_pow_unit.png", width = 10, height = 6)
```



```{r, fig.width=10, fig.height=6}
ggarrange(ggplot(results_setting_2_alpha %>% filter(study_arm==3, unit_size==100)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid( ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_setting_2_pow %>% filter(study_arm==3, unit_size==100)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid( ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom",
          nrow = 2) + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_cal_alpha_pow_lambda.png", width = 10, height = 6)
```



## Appendix

- Rows - unit size

```{r, fig.width=10, fig.height=15}
ggarrange(ggplot(results_setting_2_alpha %>% filter(study_arm==3, unit_size %in% c(25, 50, 100, 200, 300))) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(unit_size ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_setting_2_pow %>% filter(study_arm==3, unit_size %in% c(25, 50, 100, 200, 300))) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(unit_size ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom",
          nrow = 2) + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_cal_alpha_pow_lambda_all_units.png", width = 10, height = 15)
```


- Rows - investigated arm

```{r, fig.width=10, fig.height=10}
ggarrange(ggplot(results_setting_2_alpha %>% filter(unit_size==100)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_setting_2_pow %>% filter(unit_size==100)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom",
          nrow = 2) + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_cal_alpha_pow_lambda_all_arms.png", width = 10, height = 10)
```


- Rows - investigated arm

```{r, fig.width=10, fig.height=12}
ggarrange(ggplot(results_setting_2_alpha %>% filter(lambda1==0.125)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(unit_size, reject_h0, color = as.factor(model))) +
            geom_point(aes(unit_size, reject_h0, color = as.factor(model)), size = 1) +
            labs(x="Calendar unit size", y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_setting_2_pow %>% filter(lambda1==0.125)) +
            geom_line(aes(unit_size, reject_h0, color = as.factor(model))) +
            geom_point(aes(unit_size, reject_h0, color = as.factor(model)), size = 1) +
            labs(x="Calendar unit size", y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom",
          nrow = 2) + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_cal_alpha_pow_unit_all_arms.png", width = 10, height = 12)
```

# SETTING 3 - 4 treatment arms

## Main text

```{r, fig.width=10, fig.height=6}
ggarrange(ggplot(results_setting_3_alpha %>% filter(study_arm==3, unit_size==100)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed - period", "Mixed - period", "Mixed (AR1) - period", 
                                          "Mixed (AR1) - calendar", "Mixed - calendar", "Separate analysis"),
                               values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw(),
          
          ggplot(results_setting_3_pow %>% filter(study_arm==3, unit_size==100)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed - period", "Mixed - period", "Mixed (AR1) - period", 
                                          "Mixed (AR1) - calendar", "Mixed - calendar", "Separate analysis"),
                               values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw(),
          
          common.legend = T, legend = "bottom",
          nrow = 2) + 
  bgcolor("white") + 
  border("white")

ggsave("figures/mixmodel_cal_alpha_pow_lambda.png", width = 10, height = 6)
```

## Appendix

- Rows - investigated arm

```{r, fig.width=10, fig.height=10}
ggarrange(ggplot(results_setting_3_alpha %>% filter(unit_size==100)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed - period", "Mixed - period", "Mixed (AR1) - period", 
                                          "Mixed (AR1) - calendar", "Mixed - calendar", "Separate analysis"),
                               values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw(),
          
          ggplot(results_setting_3_pow %>% filter(unit_size==100)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed - period", "Mixed - period", "Mixed (AR1) - period", 
                                          "Mixed (AR1) - calendar", "Mixed - calendar", "Separate analysis"),
                               values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw(),
          
          common.legend = T, legend = "bottom",
          nrow = 2) + 
  bgcolor("white") + 
  border("white")

ggsave("figures/mixmodel_cal_alpha_pow_lambda_all_arms.png", width = 10, height = 10)
```



- Rows - unit size


```{r, fig.width=10, fig.height=10}
ggarrange(ggplot(results_setting_3_alpha %>% filter(study_arm==3)) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed - period", "Mixed - period", "Mixed (AR1) - period", 
                                          "Mixed (AR1) - calendar", "Mixed - calendar", "Separate analysis"),
                               values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(unit_size ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw(),
          
          ggplot(results_setting_3_pow %>% filter(study_arm==3)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed - period", "Mixed - period", "Mixed (AR1) - period", 
                                          "Mixed (AR1) - calendar", "Mixed - calendar", "Separate analysis"),
                               values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(unit_size ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw(),
          
          common.legend = T, legend = "bottom",
          nrow = 2) + 
  bgcolor("white") + 
  border("white")

ggsave("figures/mixmodel_cal_alpha_pow_lambda_all_sizes.png", width = 10, height = 10)
```


# SETTING 4 - 7 treatment arms

## Main text

```{r, fig.width=6, fig.height=4}
d <- 250
trial_data <- datasim_cont(num_arms = 7, n_arm = 250, d = d*c(0,1,1,2,2,3,3), theta = rep(0, 7), lambda = rep(0.5, 8), sigma = 1, trend = "stepwise_2", full = T)$Data

plot_trial(trial_data$treatment) +
  scale_color_manual(values = c(rep("gray48", 3), "darkred", rep("gray48", 4)))

ggsave("figures/trial_7arms.png", width = 6, height = 4)
```


```{r, fig.width=10, fig.height=6}
ggarrange(ggplot(results_setting_4_alpha %>% filter(study_arm==3, bs_degree==3, unit_size==100, model!="sepmodel")) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed regression model", "Splines within periods", "Splines within calendar times"), values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(~ trend,
                       labeller = labeller(trend = as_labeller(trend_names))) +
            theme_bw(),

          ggplot(results_setting_4_pow %>% filter(study_arm==3, bs_degree==3, unit_size==100, model!="sepmodel")) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed regression model", "Splines within periods", "Splines within calendar times"), values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw(),

          common.legend = T, legend = "bottom",
          nrow = 2) +
  bgcolor("white") +
  border("white")

ggsave("figures/splines_alpha_pow_lambda_trend.png", width = 10, height = 6)
```



## Appendix

- Rows - investigated arm


```{r, fig.width=10, fig.height=15}
ggarrange(ggplot(results_setting_4_alpha %>% filter(bs_degree==3, unit_size==100, model!="sepmodel")) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed regression model", "Splines within periods", "Splines within calendar times"), values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend = as_labeller(trend_names))) +
            theme_bw(),

          ggplot(results_setting_4_pow %>% filter(bs_degree==3, unit_size==100, model!="sepmodel")) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed regression model", "Splines within periods", "Splines within calendar times"), values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(study_arm ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw(),

          common.legend = T, legend = "bottom",
          nrow = 2) +
  bgcolor("white") +
  border("white")

ggsave("figures/splines_alpha_pow_lambda_trend_all_arms.png", width = 10, height = 15)
```


- Rows - unit size


```{r, fig.width=10, fig.height=15}
ggarrange(ggplot(results_setting_4_alpha %>% filter(study_arm==3, bs_degree==3, model!="sepmodel")) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed regression model", "Splines within periods", "Splines within calendar times"), values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(unit_size ~ trend,
                       labeller = labeller(trend = as_labeller(trend_names))) +
            theme_bw(),

          ggplot(results_setting_4_pow %>% filter(study_arm==3, bs_degree==3, model!="sepmodel")) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed regression model", "Splines within periods", "Splines within calendar times"), values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(unit_size ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names))) +
            theme_bw(),

          common.legend = T, legend = "bottom",
          nrow = 2) +
  bgcolor("white") +
  border("white")

ggsave("figures/splines_alpha_pow_lambda_trend_all_sizes.png", width = 10, height = 15)
```

- Rows - spline degree


```{r, fig.width=10, fig.height=15}
ggarrange(ggplot(results_setting_4_alpha %>% filter(study_arm==3, unit_size==100, model!="sepmodel")) +
            geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = pred_int[1], ymax = pred_int[2]), fill = "gray84") +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed regression model", "Splines within periods", "Splines within calendar times"), values = my_palette) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(bs_degree ~ trend,
                       labeller = labeller(trend = as_labeller(trend_names),
                                           bs_degree = as_labeller(degree_names))) +
            theme_bw(),

          ggplot(results_setting_4_pow %>% filter(study_arm==3, unit_size==100, model!="sepmodel")) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_manual(labels = c("Fixed regression model", "Splines within periods", "Splines within calendar times"), values = my_palette) +
            coord_cartesian(ylim = c(0.70, 1)) +
            facet_grid(bs_degree ~ trend,
                       labeller = labeller(trend  = as_labeller(trend_names),
                                           bs_degree = as_labeller(degree_names))) +
            theme_bw(),

          common.legend = T, legend = "bottom",
          nrow = 2) +
  bgcolor("white") +
  border("white")

ggsave("figures/splines_alpha_pow_lambda_trend_all_degrees.png", width = 10, height = 15)
```













