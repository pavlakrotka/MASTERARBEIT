---
title: "MT: Model-based Adjustments for Non-concurrent Comparisons in Platform Trials - preliminary simulations"
author: "Pavla Krotka, Marta Bofill Roig"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: true
    number_sections: true
    code_folding: show 
    theme: flatly
---

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(collapse = TRUE,
               echo = FALSE,
               comment = "#>",
               warning = FALSE,
               message = FALSE,
               fig.align = "center",
               out.width = "100%")
```

```{r, warning=FALSE, message=FALSE, include=FALSE}
library(tidyverse)
library(kableExtra)
library(latex2exp)
library(ggpubr)
library(NCC)
library(mgcv)
library(splines)
set.seed(717)
```

```{r}
results_iv_eq_alpha <- read_csv("results/results_iv_eq_alpha.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))

sim_results_Ch4 <- read_csv("results/sim_results_Ch4.csv")

results_iv_eq_pow <- read_csv("results/results_iv_eq_pow.csv") %>%
  mutate(trend = case_when(trend=="seasonal" & n_wave==1 ~ "seasonal_1",
                           trend=="seasonal" & n_wave==2 ~ "seasonal_2",
                           TRUE ~ trend))
```


# Scenario with 7 arms

- 7 experimental treatment arms
- $n=250$
- equal time trend - $\lambda \in [-0.5; 0.5]$
- entry times $d = 250 \cdot (0,1,1,2,2,3,3)$
- $\theta_k=0.25$ under $H_1$
- linear, stepwise (jump only when new arm enters), inverted u ($N_{peak}=914$) and seasonal ($\psi=1,2$) time trends
- inference for 7th treatment arm

## Overview

```{r}
d <- 250
trial_data <- datasim_cont(num_arms = 7, n_arm = 250, d = d*c(0,1,1,2,2,3,3), theta = rep(0, 7), lambda = rep(0.5, 8), sigma = 1, trend = "stepwise_2", full = T)$Data

plot_trial(trial_data$treatment) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d = ", d))

ggplot(trial_data) +
  geom_point(aes(x=j, y=means, color=as.factor(treatment)), size=2) +
  labs(x = "Patients in the trial", y = "Mean response under H0", color="Treatment", title = "Mean response")

# ggplot(trial_data) +
#   geom_point(aes(x=j, y=response, color=as.factor(treatment)), size=2, alpha=0.7) +
#   labs(x = "Patients in the trial", y = "Response", color="Treatment", title = "Simulated response")
```



## Results

### Test Ch4

```{r}
ggplot(sim_results_Ch4, aes(x=lambda0, y=reject_h0, color=model)) +
  geom_point() +
  geom_line() +
  facet_grid(~ trend) +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  labs(x="Strength of time trend", y="Type I error", color="Analysis approach") +
  theme_bw()
```


### Linear polynomials

```{r}
ggplot(results_iv_eq_alpha %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==5, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


```{r}
ggplot(results_iv_eq_pow %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==1)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


### Quadratic polynomials

```{r}
ggplot(results_iv_eq_alpha %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==2)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model), linetype = as.factor(study_arm))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


```{r}
ggplot(results_iv_eq_pow %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==2)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```



### Cubic polynomials

```{r}
ggplot(results_iv_eq_alpha %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==3)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Model:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


```{r}
ggplot(results_iv_eq_pow %>% filter(model %in% c("fixmodel", "splines", "splines_cal", "piecewise", "piecewise_cal"), trend %in% c("linear", "seasonal_1", "seasonal_2", "stepwise_2", "inv_u"), study_arm==7, poly_degree==3)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Power", color="Model:") +
  facet_grid(~ trend) +
  theme(legend.position = "bottom")
```


# Plots presentation - Master's seminar

## Periods vs. calendar time

```{r}
d <- 250
trial_data <- datasim_cont(num_arms = 4, n_arm = 250, d = d*c(0:3), theta = rep(0, 4), lambda = rep(0.5, 5), sigma = 1, trend = "stepwise_2", full = T)$Data

plot_trial(trial_data$treatment) +
  #coord_cartesian(xlim = c(0, 5000)) +
  #labs(title = paste0("d = ", d)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c(rep("gray48", 3), "darkred", rep("gray48", 1)))


ggsave("figures/trial_4arms.png", width = 6, height = 4 )
```

```{r}
ggarrange(ggplot(results_iii_eq_alpha %>% filter(model %in% c("fixmodel", "fixmodel_cal", "sepmodel"), trend %in% c("linear"), study_arm==3, poly_degree==1)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
            scale_color_brewer(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), palette="Set1") +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            coord_cartesian(ylim = c(0, 0.1)) +
            #facet_grid(~ trend) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_iii_eq_pow %>% filter(model %in% c("fixmodel", "fixmodel_cal", "sepmodel"), trend %in% c("linear"), study_arm==3, poly_degree==1)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:") +
            scale_color_brewer(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), palette="Set1") +
            coord_cartesian(ylim = c(0.75, 0.9)) +
            #facet_grid(~ trend) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_cal_alpha_pow_lambda.png", width = 10, height = 3)
```



```{r}
ggarrange(ggplot(results_v_eq_alpha %>% filter(model %in% c("fixmodel", "fixmodel_cal", "sepmodel"), trend %in% c("linear"), study_arm==3, poly_degree==1)) +
            geom_line(aes(unit_size, reject_h0, color = as.factor(model))) +
            geom_point(aes(unit_size, reject_h0, color = as.factor(model))) +
            labs(x="Calendar unit size", y="Type I error", color="Analysis approach:") +
            scale_color_brewer(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), palette="Set1") +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            coord_cartesian(ylim = c(0, 0.1)) +
            #facet_grid(~ trend) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_v_eq_pow %>% filter(model %in% c("fixmodel", "fixmodel_cal", "sepmodel"), trend %in% c("linear"), study_arm==3, poly_degree==1)) +
            geom_line(aes(unit_size, reject_h0, color = as.factor(model))) +
            geom_point(aes(unit_size, reject_h0, color = as.factor(model))) +
            labs(x="Calendar unit size", y="Power", color="Analysis approach:") +
            scale_color_brewer(labels = c("Period adjustment", "Calendar time adjustment", "Separate analysis"), palette="Set1") +
            coord_cartesian(ylim = c(0.75, 0.9)) +
            #facet_grid(~ trend) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

ggsave("figures/fixmodel_cal_alpha_pow_unit.png", width = 10, height = 3)
```



## Mixed models


```{r}
ggarrange(ggplot(results_iii_eq_alpha %>% filter(model %in% c("fixmodel", "mixmodel", "mixmodel_cal", "mixmodel_AR1", "mixmodel_AR1_cal"), trend %in% c("linear"), study_arm==3, poly_degree==1)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:", title = "Calendar unit size = 25") +
            scale_color_discrete(labels = c("Fixed - period", "Mixed - period", "Mixed (AR1) - period", "Mixed (AR1) - calendar", "Mixed (AR1) - period")) +
            geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
            #coord_cartesian(ylim = c(0, 0.1)) +
            #facet_grid(~ trend) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          ggplot(results_iii_eq_pow %>% filter(model %in% c("fixmodel", "mixmodel", "mixmodel_cal", "mixmodel_AR1", "mixmodel_AR1_cal"), trend %in% c("linear"), study_arm==3, poly_degree==1)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:", title = "Calendar unit size = 25") +
            scale_color_discrete(labels = c("Fixed - period", "Mixed - period", "Mixed (AR1) - period", "Mixed (AR1) - calendar", "Mixed (AR1) - period")) +
            #coord_cartesian(ylim = c(0, 0.1)) +
            #facet_grid(~ trend) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

#ggsave("figures/mixmodel_cal_alpha_lambda_unit.png", width = 10, height = 4)
```


## Splines


```{r}
d <- 250
trial_data <- datasim_cont(num_arms = 7, n_arm = 250, d = d*c(0,1,1,2,2,3,3), theta = rep(0, 7), lambda = rep(0.5, 8), sigma = 1, trend = "stepwise_2", full = T)$Data

plot_trial(trial_data$treatment) +
  #coord_cartesian(xlim = c(0, 5000)) +
  #theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c(rep("gray48", 3), "darkred", rep("gray48", 4)))

ggsave("figures/trial_7arms.png", width = 6, height = 4 )
```




```{r}
trend_names <- c(linear = "Linear trend", stepwise_2 = "Stepwise trend", inv_u = "Inverted-U trend", seasonal_2 = "Seasonal trend")

ggplot(results_iv_eq_alpha %>% filter(model %in% c("fixmodel", "splines", "splines_cal"), trend %in% c("linear", "inv_u", "seasonal_2", "stepwise_2"), study_arm==3, poly_degree==3)) +
  geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
  geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
  labs(x=TeX("$\\lambda$"), y="Type I error", color="Analysis approach:") +
  scale_color_brewer(labels = c("Fixed regression model", "Splines within periods", "Splines within calendar times"), palette="Set1") +
  #scale_color_discrete(labels = c("Fixed model - period", "Spines - period", "Splines - calendar")) +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  #coord_cartesian(ylim = c(0, 0.1)) +
  facet_grid(~ trend,
             labeller = labeller(trend = as_labeller(trend_names))) +
  theme_bw() +
  theme(legend.position="bottom")

ggsave("figures/splines_alpha_lambda_trend.png", width = 10, height = 3)
```



```{r}
trend_names <- c(linear = "Linear trend", stepwise_2 = "Stepwise trend", inv_u = "Inverted-U trend", seasonal_2 = "Seasonal trend")

ggarrange(ggplot(results_iv_eq_pow %>% filter(model %in% c("fixmodel", "splines", "splines_cal"), trend %in% c("linear", "inv_u", "seasonal_2", "stepwise_2"), study_arm==3, poly_degree==3)) +
            geom_line(aes(lambda1, reject_h0, color = as.factor(model))) +
            geom_point(aes(lambda1, reject_h0, color = as.factor(model))) +
            labs(x=TeX("$\\lambda$"), y="Power", color="Analysis approach:", title = "Calendar unit size = 25") +
            scale_color_discrete(labels = c("Fixed model - period", "Spines - period", "Splines - calendar")) +
            #coord_cartesian(ylim = c(0, 0.1)) +
            facet_grid(~ trend,
                       labeller = labeller(trend = as_labeller(trend_names))) +
            theme_bw() +
            theme(plot.title = element_text(hjust = 0.5)),
          
          common.legend = T, legend = "bottom") + 
  bgcolor("white") + 
  border("white")

#ggsave("figures/splines_pow_lambda_trend.png", width = 10, height = 4)
```




## All scenarios


```{r}
trial_data_10 <- datasim_cont(num_arms = 10, n_arm = 250, d = 400*c(0:9), theta = rep(0, 10), lambda = rep(0.5, 11), sigma = 1, trend = "stepwise_2", full = T)$Data

trial_data_4 <- datasim_cont(num_arms = 4, n_arm = 250, d = 250*c(0:3), theta = rep(0, 4), lambda = rep(0.5, 5), sigma = 1, trend = "stepwise_2", full = T)$Data

trial_data_7 <- datasim_cont(num_arms = 7, n_arm = 250, d = 250*c(0,1,1,2,2,3,3), theta = rep(0, 7), lambda = rep(0.5, 8), sigma = 1, trend = "stepwise_2", full = T)$Data


ggarrange(plot_trial(trial_data_10$treatment) +
            #coord_cartesian(xlim = c(0, 5000)) +
            #labs(title = paste0("d = ", d)) +
            theme(plot.title = element_text(hjust = 0.5)) +
            scale_color_manual(values = c(rep("gray48", 5), "darkred", rep("gray48", 5))),
          
          plot_trial(trial_data_4$treatment) +
            #coord_cartesian(xlim = c(0, 5000)) +
            #labs(title = paste0("d = ", d)) +
            theme(plot.title = element_text(hjust = 0.5)) +
            scale_color_manual(values = c(rep("gray48", 3), "darkred", rep("gray48", 1))),
          
          plot_trial(trial_data_7$treatment) +
            #coord_cartesian(xlim = c(0, 5000)) +
            #theme(plot.title = element_text(hjust = 0.5)) +
            scale_color_manual(values = c(rep("gray48", 3), "darkred", rep("gray48", 4))),
          
          nrow = 1)

ggsave("figures/all_trials.png", width = 12, height = 3)
```














